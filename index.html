<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Olympia Invoice</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useEffect } = React;

    // ======================================================================
    // ICON COMPONENTS
    // ======================================================================
    const Printer = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <polyline points="6 9 6 2 18 2 18 9"></polyline>
        <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path>
        <rect x="6" y="14" width="12" height="8"></rect>
      </svg>
    );

    const Plus = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="12" y1="5" x2="12" y2="19"></line>
        <line x1="5" y1="12" x2="19" y2="12"></line>
      </svg>
    );

    const X = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <line x1="18" y1="6" x2="6" y2="18"></line>
        <line x1="6" y1="6" x2="18" y2="18"></line>
      </svg>
    );

    const Save = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
        <polyline points="17 21 17 13 7 13 7 21"></polyline>
        <polyline points="7 3 7 8 15 8"></polyline>
      </svg>
    );

    const FolderOpen = ({ size = 24 }) => (
      <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
      </svg>
    );

    // ======================================================================
    // INVOICE TEMPLATE SYSTEM
    // ======================================================================
    async function loadInvoiceTemplate() {
      try {
        if (typeof require !== 'undefined') {
          const fs = require('fs');
          const path = require('path');
          const templatePath = path.join(__dirname, 'invoice-template.html');
          return fs.readFileSync(templatePath, 'utf-8');
        }
      } catch (error) {
        console.error('Error loading template:', error);
      }
      return getDefaultInvoiceTemplate();
    }

    function getDefaultInvoiceTemplate() {
      return `<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Invoice - {{CLIENT_NAME}}</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; margin: 0; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 30px; margin: 10px 0; }
    .header p { font-size: 22px; margin: 10px 0; }
    .header h2 { font-size: 24px; margin: 20px 0 10px 0; }
    .contact-info { display: flex; justify-content: space-between; margin-bottom: 20px; }
    .contact-info p { font-size: 19px; margin: 5px 0; }
    .info { margin: 20px 0; }
    .info p { margin: 8px 0; font-size: 16px; }
    .info strong { font-weight: 600; }
    .client-name { font-size: 22px; }
    table { width: 100%; border-collapse: collapse; margin: 20px 0; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background-color: #f2f2f2; font-weight: bold; }
    .totals { font-weight: bold; background-color: #f9f9f9; }
    .grand-total { text-align: right; font-size: 24px; font-weight: bold; margin: 20px 0; }
    .disclaimer { font-size: 18px; margin-top: 20px; color: #333; }
    .qr-code { text-align: center; margin-top: 30px; }
    .qr-code img { width: auto; height: 220px; }
  </style>
</head>
<body>
  <div class="header">
    <h1>á¢á¼á¡á¶áŸ†á–áŸ’á™á¶ á…á¶á€áŸ‹á–á»á˜áŸ’á–á‚áŸ’ášá¿á„á¢á›á„áŸ’á€á¶áš</h1>
    <p>á˜á¶á“á‘á‘á½á›á…á¶á€áŸ‹á–á»á˜áŸ’á–á‚áŸ’ášá¿á„á¢á›á„áŸ’á€á¶ášá‚áŸ’ášá”áŸ‹á”áŸ’ášá—áŸá‘ áŠáŸ„á™á˜áŸ‰á¶áŸáŸ’áŸá¸á“áŸáŸ’áœáŸá™á”áŸ’ášáœááŸ’áá·á™áŸ‰á¶á„á‘áŸ†á“á¾á”á‘á¶á“áŸ‹á…á·ááŸ’á</p>
    <h2>áœá·á€áŸá™á”áŸááŸ’áš / INVOICE</h2>
  </div>
  
  <div class="contact-info">
    <div>
      <p><strong>TEL:</strong> 012205358<br/>
      &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;061848616</p>
    </div>
    <div style="text-align: right;">
      <p>á•áŸ’á‘áŸ‡á›áŸá10C1E0 á•áŸ’á›á¼áœá›áŸá211<br/>áŸá„áŸ’á€á¶ááŸ‹áœá¶á›áœá„áŸ‹ áááŸ’áŒáŸ§á˜á€ášá¶</p>
    </div>
  </div>
  
  <div class="info">
    <p><strong>áˆáŸ’á˜áŸ„áŸ‡á¢áá·áá·á‡á“ / Client Name: <span class="client-name">{{CLIENT_NAME}}</span></strong></p>
    <p><strong>ááŸ’á„áŸƒá‘á¸ / Date:</strong> {{DATE}}</p>
    <p><strong>á•áŸ’á›á¶á‘á¸á“á‘á¹á€ / Gold Mix:</strong> {{GOLD_MIX}}</p>
    <p><strong>á á¶á„á†áŸá„ / Gold Market Price:</strong> ${{GOLD_PRICE}}</p>
  </div>
  
  <table>
    <thead>
      <tr>
        <th>á”áŸ’ášá—áŸá‘á‚áŸ’ášá¿á„<br/>Type of Goods</th>
        <th style="text-align: center;">á…áŸ†á“á½á“<br/>Qty</th>
        <th style="text-align: center;">á‘áŸ†á„á“áŸ‹<br/>Weight (l)</th>
        <th style="text-align: right;">áˆáŸ’á“á½á›<br/>Labor</th>
        <th style="text-align: right;">áŸášá»á”<br/>Total</th>
      </tr>
    </thead>
    <tbody>
      {{ITEMS_ROWS}}
      <tr class="totals">
        <td>áŸášá»á” / TOTAL</td>
        <td style="text-align: center;">{{TOTAL_QTY}}</td>
        <td style="text-align: center;">{{TOTAL_WEIGHT}}</td>
        <td style="text-align: right;">\${{TOTAL_LABOR}}</td>
        <td></td>
      </tr>
    </tbody>
  </table>
  
  <div class="grand-total">
    áŸášá»á”ášá½á˜ / GRAND TOTAL: \${{GRAND_TOTAL}}
  </div>
  
  <div class="disclaimer">
    <p>á¢áŸ’á“á€á‘á·á‰á”á¶á“á˜á¾á› ááŸ’á›á¹á„ á“á¹á„á™á›áŸ‹á–áŸ’ášá˜áá¶á˜á‘áŸ†á„á“áŸ‹áá¶á„á›á¾ááŸ’ášá¹á˜ááŸ’ášá¼áœáŸ”</p>
  </div>
  
  {{QR_CODE_SECTION}}
</body>
</html>`;
    }

    async function generateInvoiceHTML(formData, goldMixOptions, qrCodeImage, calculateItemTotal, formatDate, roundTotal) {
      const template = await loadInvoiceTemplate();
      
      const totals = {
        totalQty: formData.items.reduce((sum, item) => sum + parseInt(item.quantity || 0), 0),
        totalWeight: formData.items.reduce((sum, item) => {
          return sum + item.subItems.reduce((s, sub) => s + (parseFloat(sub.weight) || 0), 0);
        }, 0),
        totalLabor: formData.items.reduce((sum, item) => {
          return sum + item.subItems.reduce((s, sub) => s + (parseFloat(sub.laborCost) || 0), 0);
        }, 0)
      };

      const rawGrandTotal = formData.items.reduce((sum, item) => sum + calculateItemTotal(item), 0);
      const grandTotal = roundTotal(rawGrandTotal);

      const itemsRows = formData.items.map(item => {
        const totalWeight = item.subItems.reduce((sum, sub) => sum + (parseFloat(sub.weight) || 0), 0);
        const totalLabor = item.subItems.reduce((sum, sub) => sum + (parseFloat(sub.laborCost) || 0), 0);
        return `
        <tr>
          <td>${item.itemName}${item.productCode ? ` N${item.productCode}` : ''}</td>
          <td style="text-align: center;">${item.quantity}${item.qtyUnit || ''}</td>
          <td style="text-align: center;">${totalWeight.toFixed(1)}</td>
          <td style="text-align: right;">$${totalLabor}</td>
          <td style="text-align: right;">$${(() => {
            const v = calculateItemTotal(item);
            const d = v - Math.floor(v);
            return (d >= 0.7 ? Math.ceil(v) : Math.floor(v)).toLocaleString();})()}</td>
        </tr>`;
      }).join('');

      const qrCodeSection = qrCodeImage 
        ? `<div class="qr-code"><img src="${qrCodeImage}" alt="Payment QR Code" /></div>` 
        : '';

      let html = template
        .replace(/{{CLIENT_NAME}}/g, formData.clientName)
        .replace(/{{DATE}}/g, formatDate(formData.date))
        .replace(/{{GOLD_MIX}}/g, goldMixOptions.find(o => o.value === formData.goldMix)?.label || '')
        .replace(/{{GOLD_PRICE}}/g, formData.goldPrice)
        .replace(/{{ITEMS_ROWS}}/g, itemsRows)
        .replace(/{{TOTAL_QTY}}/g, totals.totalQty)
        .replace(/{{TOTAL_WEIGHT}}/g, totals.totalWeight.toFixed(1))
        .replace(/{{TOTAL_LABOR}}/g, totals.totalLabor)
        .replace(/{{GRAND_TOTAL}}/g, grandTotal.toLocaleString())
        .replace(/{{QR_CODE_SECTION}}/g, qrCodeSection);

      return html;
    }

    // ======================================================================
    // HEADER COMPONENT
    // ======================================================================
    function Header({ formData, setFormData, saveDraft, handleSaveReceipt, globalGoldPrice, setGlobalGoldPrice }) {
      return (
        <div className="fixed top-0 left-0 right-0 bg-white shadow-md border-b border-gray-200 z-40">
          <div className="flex items-center justify-between px-6 py-4">
            <div className="flex items-center gap-4">
              <h1 className="text-2xl font-bold text-gray-800">
                áœá·á€áŸá™á”áŸááŸ’áš / Invoice
              </h1>
              <input
                type="date"
                value={formData.date}
                onChange={(e) => setFormData({ ...formData, date: e.target.value })}
                className="px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
              />
            </div>

            <div className="flex items-center gap-2">
              <label className="text-sm font-medium text-gray-700 whitespace-nowrap">
                Today's Gold Price:
              </label>
              <div className="relative">
                <span className="absolute left-3 top-2.5 text-gray-500">$</span>
                <input
                  type="number"
                  step="1"
                  value={globalGoldPrice}
                  onChange={(e) => {
                    const newPrice = e.target.value;
                    setGlobalGoldPrice(newPrice);
                    localStorage.setItem('jewelryGlobalGoldPrice', newPrice);
                  }}
                  placeholder="Set price"
                  className="w-32 pl-7 pr-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                />
              </div>
            </div>

            <div className="flex items-center gap-3">
              <button
                onClick={saveDraft}
                className="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 flex items-center gap-2"
              >
                <Save size={18} />
                ášá€áŸ’áŸá¶á‘á»á€ / Save Draft
              </button>
              <button
                onClick={handleSaveReceipt}
                className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-2"
              >
                <FolderOpen size={18} />
                ášá€áŸ’áŸá¶á‘á»á€ PDF / Save as PDF
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ======================================================================
    // GROUPED TYPE SELECTOR POPUP
    // ======================================================================
    function GroupedTypeSelector({ groups, onSelect, onClose }) {
      const rows = [];
      for (let i = 0; i < groups.length; i += 3) {
        rows.push(groups.slice(i, i + 3));
      }

      return (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
          onClick={onClose}
        >
          <div 
            className="bg-white rounded-lg p-6 max-w-4xl max-h-[80vh] overflow-y-auto"
            onClick={(e) => e.stopPropagation()}
          >
            <div className="flex justify-between items-center mb-4">
              <h3 className="text-xl font-bold">á‡áŸ’ášá¾áŸášá¾áŸá”áŸ’ášá—áŸá‘á‚áŸ’ášá¿á„ / Select Type of Goods</h3>
              <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
                <X size={24} />
              </button>
            </div>

            <div className="space-y-4">
              {rows.map((row, rowIdx) => (
                <div key={rowIdx} className="grid grid-cols-3 gap-4">
                  {row.map((group, colIdx) => (
                    <div key={colIdx} className="border rounded-lg p-4 bg-gray-50">
                      <h4 className="font-semibold text-lg mb-3 text-blue-700 border-b pb-2">
                        {group.name}
                      </h4>
                      <div className="space-y-1">
                        {group.items.map((item, itemIdx) => (
                          <button
                            key={itemIdx}
                            onClick={() => {
                              onSelect(item);
                              onClose();
                            }}
                            className="w-full text-left px-3 py-2 rounded hover:bg-blue-100 transition-colors text-sm"
                          >
                            {item}
                          </button>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              ))}
            </div>
          </div>
        </div>
      );
    }

    // ======================================================================
    // INPUT MODAL COMPONENT
    // ======================================================================
    function InputModal({ isOpen, title, defaultValue, onSubmit, onCancel }) {
      const [value, setValue] = useState(defaultValue || '');

      useEffect(() => {
        setValue(defaultValue || '');
      }, [defaultValue, isOpen]);

      if (!isOpen) return null;

      const handleSubmit = (e) => {
        e.preventDefault();
        if (value.trim()) {
          onSubmit(value.trim());
          setValue('');
        }
      };

      return (
        <div 
          className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
          onClick={onCancel}
        >
          <div 
            className="bg-white rounded-lg p-6 w-96"
            onClick={(e) => e.stopPropagation()}
          >
            <h3 className="text-lg font-bold mb-4">{title}</h3>
            <form onSubmit={handleSubmit}>
              <input
                type="text"
                value={value}
                onChange={(e) => setValue(e.target.value)}
                className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 mb-4"
                autoFocus
                placeholder="Enter value..."
              />
              <div className="flex gap-2 justify-end">
                <button
                  type="button"
                  onClick={onCancel}
                  className="px-4 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                  OK
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    }

    // ======================================================================
    // SIDEBAR COMPONENT
    // ======================================================================
    function Sidebar({ currentPage, setCurrentPage, drafts, activeTab, loadDraft, deleteDraft, addNewDraft, restartPrintSpooler }) {
      return (
        <div className="fixed left-0 top-20 bottom-0 w-64 bg-white shadow-lg p-4 overflow-y-auto">
          <div className="space-y-2 mb-6">
            <button
              onClick={() => setCurrentPage('invoice')}
              className={`w-full text-left px-4 py-2 rounded ${currentPage === 'invoice' ? 'bg-blue-100 text-blue-700 font-semibold' : 'hover:bg-gray-100'}`}
            >
              ğŸ“„ Invoice
            </button>
            <button
              onClick={() => setCurrentPage('payment')}
              className={`w-full text-left px-4 py-2 rounded ${currentPage === 'payment' ? 'bg-blue-100 text-blue-700 font-semibold' : 'hover:bg-gray-100'}`}
            >
              ğŸ’° Payment History
            </button>
            <button
              onClick={() => setCurrentPage('settings')}
              className={`w-full text-left px-4 py-2 rounded ${currentPage === 'settings' ? 'bg-blue-100 text-blue-700 font-semibold' : 'hover:bg-gray-100'}`}
            >
              âš™ï¸ Settings
            </button>
            <button
              onClick={restartPrintSpooler}
              className="w-full text-left px-4 py-2 rounded bg-red-100 text-red-700 hover:bg-red-200 font-semibold"
            >
              ğŸ–¨ï¸ Fix Printer
            </button>
          </div>

          <div className="border-t pt-4">
            <div className="flex justify-between items-center mb-2">
              <span className="text-sm font-semibold">Drafts</span>
              <button
                onClick={addNewDraft}
                className="w-6 h-6 bg-green-600 text-white rounded flex items-center justify-center hover:bg-green-700"
              >
                <Plus size={14} />
              </button>
            </div>
            <div className="space-y-1 max-h-96 overflow-y-auto">
              {drafts.map((draft, idx) => {
                const orderItems = draft.items.map(i => i.itemName).filter(Boolean).join(', ');
                const draftName = `${idx + 1} - ${draft.clientName || 'New'}${orderItems ? `_${orderItems}` : ''}`;
                return (
                  <button
                    key={idx}
                    onClick={() => {
                      loadDraft(idx);
                      setCurrentPage('invoice');
                    }}
                    className={`w-full text-left px-2 py-1 text-xs rounded flex items-center justify-between group ${
                      activeTab === idx ? 'bg-blue-100' : 'hover:bg-gray-100'
                    }`}
                  >
                    <span className="truncate">{draftName}</span>
                    <button
                      onClick={(e) => {
                        e.stopPropagation();
                        deleteDraft(idx);
                      }}
                      className="opacity-0 group-hover:opacity-100"
                    >
                      <X size={12} />
                    </button>
                  </button>
                );
              })}
            </div>
          </div>
        </div>
      );
    }

    // ======================================================================
    // MAIN COMPONENT
    // ======================================================================
    function ReceiptCalculator() {
      const [clients, setClients] = useState([]);
      const [newClientName, setNewClientName] = useState('');
      const [showPrintView, setShowPrintView] = useState(false);
      const [currentPage, setCurrentPage] = useState('invoice');
      const [drafts, setDrafts] = useState([]);
      const [activeTab, setActiveTab] = useState(0);
      const [savePath, setSavePath] = useState('');
      const [qrCodeImage, setQrCodeImage] = useState('');
      const [paymentHistory, setPaymentHistory] = useState([]);
      const [showTypeSelector, setShowTypeSelector] = useState(false);
      const [currentItemIndex, setCurrentItemIndex] = useState(null);
      const [globalGoldPrice, setGlobalGoldPrice] = useState('');
      const [showInputModal, setShowInputModal] = useState(false);
      const [inputModalData, setInputModalData] = useState({ title: '', defaultValue: '', onSubmit: null });
      
      const [formData, setFormData] = useState({
        date: new Date().toISOString().split('T')[0],
        clientName: '',
        goldMix: '',
        goldPrice: '',
        items: [{ 
          itemName: '', 
          quantity: '1',
          qtyUnit: '',
          productCode: '',
          subItems: [{ weight: '', laborCost: '' }],
          manualTotal: null
        }]
      });

      const [itemTypeGroups, setItemTypeGroups] = useState([
        {
          name: '3D Series',
          items: ['ááŸ’áŸáŸ‚á€ SVZ', 'ááŸ’áŸáŸ‚áŠáŸƒ BZ']
        },
        {
          name: 'Molded Series',
          items: ['KZ', 'PZ', 'EZ', 'RZ']
        },
        {
          name: 'Client Provided',
          items: ['ááŸ’áŸáŸ‚á€', 'ááŸ’áŸáŸ‚áŠáŸƒ', 'á€á„áŠáŸƒ', 'á€áŸ’ášáœá¹á›', 'á€á¶áœ', 'á”á“áŸ’ááŸ„á„', 'á…á·á‰áŸ’á…áŸ€á“']
        }
      ]);

      const [goldMixOptions, setGoldMixOptions] = useState([
        { label: '50%', value: '50' },
        { label: '60%', value: '60' },
        { label: '65%', value: '65' },
        { label: '70%', value: '70' },
        { label: '75%', value: '75' },
        { label: '78%', value: '78' },
        { label: 'áŸ58.5%', value: '58.5' },
        { label: 'áŸ70%', value: '70-white' },
        { label: 'áŸ78%', value: '78-white' }
      ]);

      const [qtyUnitOptions, setQtyUnitOptions] = useState(['', 'P', 'áŠá»áŸ†', 'á‚á¼']);

      // Load data from localStorage
      useEffect(() => {
        const savedClients = localStorage.getItem('jewelryClients');
        if (savedClients) setClients(JSON.parse(savedClients));
        
        const savedDrafts = localStorage.getItem('jewelryDrafts');
        if (savedDrafts) setDrafts(JSON.parse(savedDrafts));
        
        const savedPath = localStorage.getItem('jewelrySavePath');
        if (savedPath) setSavePath(savedPath);

        const savedGlobalGoldPrice = localStorage.getItem('jewelryGlobalGoldPrice');
        if (savedGlobalGoldPrice) setGlobalGoldPrice(savedGlobalGoldPrice);

        const savedQR = localStorage.getItem('jewelryQRCode');
        if (savedQR) setQrCodeImage(savedQR);

        const savedPaymentHistory = localStorage.getItem('jewelryPaymentHistory');
        if (savedPaymentHistory) setPaymentHistory(JSON.parse(savedPaymentHistory));

        const savedItemTypeGroups = localStorage.getItem('jewelryItemTypeGroups');
        if (savedItemTypeGroups) setItemTypeGroups(JSON.parse(savedItemTypeGroups));

        const savedGoldMix = localStorage.getItem('jewelryGoldMix');
        if (savedGoldMix) setGoldMixOptions(JSON.parse(savedGoldMix));

        const savedQtyUnits = localStorage.getItem('jewelryQtyUnits');
        if (savedQtyUnits) setQtyUnitOptions(JSON.parse(savedQtyUnits));
      }, []);

      // Sync global gold price to formData when it changes
      useEffect(() => {
        if (globalGoldPrice && !formData.goldPrice) {
          setFormData(prev => ({ ...prev, goldPrice: globalGoldPrice }));
        }
      }, [globalGoldPrice, formData.goldPrice]);


      // ======================================================================
      // MODAL HELPER
      // ======================================================================
      const showInput = (title, defaultValue = '') => {
        return new Promise((resolve) => {
          setInputModalData({
            title,
            defaultValue,
            onSubmit: (value) => {
              setShowInputModal(false);
              resolve(value);
            }
          });
          setShowInputModal(true);
        });
      };

      const closeInputModal = () => {
        setShowInputModal(false);
        setInputModalData({ title: '', defaultValue: '', onSubmit: null });
      };

      // ======================================================================
      // GROUP MANAGEMENT
      // ======================================================================
      const saveItemTypeGroups = (newGroups) => {
        setItemTypeGroups(newGroups);
        localStorage.setItem('jewelryItemTypeGroups', JSON.stringify(newGroups));
      };

      const addGroup = (groupName) => {
        const updated = [...itemTypeGroups, { name: groupName, items: [] }];
        saveItemTypeGroups(updated);
      };

      const removeGroup = (groupIndex) => {
        const updated = itemTypeGroups.filter((_, i) => i !== groupIndex);
        saveItemTypeGroups(updated);
      };

      const renameGroup = (groupIndex, newName) => {
        const updated = [...itemTypeGroups];
        updated[groupIndex].name = newName;
        saveItemTypeGroups(updated);
      };

      const addItemToGroup = (groupIndex, itemName) => {
        const updated = [...itemTypeGroups];
        updated[groupIndex].items.push(itemName);
        saveItemTypeGroups(updated);
      };

      const removeItemFromGroup = (groupIndex, itemIndex) => {
        const updated = [...itemTypeGroups];
        updated[groupIndex].items = updated[groupIndex].items.filter((_, i) => i !== itemIndex);
        saveItemTypeGroups(updated);
      };

      // ======================================================================
      // CLIENT MANAGEMENT
      // ======================================================================
      const saveClient = () => {
        if (newClientName.trim() && !clients.includes(newClientName.trim())) {
          const updatedClients = [...clients, newClientName.trim()];
          setClients(updatedClients);
          localStorage.setItem('jewelryClients', JSON.stringify(updatedClients));
          setNewClientName('');
        }
      };

      const removeClient = (clientToRemove) => {
        const updatedClients = clients.filter(c => c !== clientToRemove);
        setClients(updatedClients);
        localStorage.setItem('jewelryClients', JSON.stringify(updatedClients));
        if (formData.clientName === clientToRemove) {
          setFormData({ ...formData, clientName: '' });
        }
      };

      // ======================================================================
      // DRAFT MANAGEMENT
      // ======================================================================
      const saveDraft = () => {
        const newDrafts = [...drafts];
        newDrafts[activeTab] = { ...formData, timestamp: new Date().toISOString() };
        setDrafts(newDrafts);
        localStorage.setItem('jewelryDrafts', JSON.stringify(newDrafts));
        alert('á‘á·á“áŸ’á“á“áŸá™ááŸ’ášá¼áœá”á¶á“ášá€áŸ’áŸá¶á‘á»á€! / Draft saved!');
      };

      const addNewDraft = () => {
        const newDraft = {
          date: new Date().toISOString().split('T')[0],
          clientName: '',
          goldMix: '',
          goldPrice: globalGoldPrice || '',
          items: [{ 
            itemName: '', 
            quantity: '1',
            qtyUnit: '',
            productCode: '',
            subItems: [{ weight: '', laborCost: '' }],
            manualTotal: null
          }],
          timestamp: new Date().toISOString()
        };
        const newDrafts = [...drafts, newDraft];
        setDrafts(newDrafts);
        setActiveTab(newDrafts.length - 1);
        setFormData(newDraft);
        localStorage.setItem('jewelryDrafts', JSON.stringify(newDrafts));
      };

      const loadDraft = (index) => {
        setActiveTab(index);
        const draft = drafts[index];
        
        const normalizedItems = draft.items.map(item => ({
          itemName: item.itemName || '',
          quantity: item.quantity || '1',
          qtyUnit: item.qtyUnit || '',
          productCode: item.productCode || '',
          subItems: Array.isArray(item.subItems) && item.subItems.length > 0 
            ? item.subItems.map(sub => ({ weight: sub.weight || '', laborCost: sub.laborCost || '' }))
            : [{ weight: '', laborCost: '' }],
          manualTotal: item.manualTotal || null
        }));
        
        setFormData({
          date: draft.date || new Date().toISOString().split('T')[0],
          clientName: draft.clientName || '',
          goldMix: draft.goldMix || '',
          goldPrice: draft.goldPrice || '',
          items: normalizedItems
        });
      };

      const deleteDraft = (index) => {
        const newDrafts = drafts.filter((_, i) => i !== index);
        setDrafts(newDrafts);
        localStorage.setItem('jewelryDrafts', JSON.stringify(newDrafts));
        if (activeTab >= newDrafts.length) {
          setActiveTab(Math.max(0, newDrafts.length - 1));
        }
        if (newDrafts.length > 0) {
          loadDraft(Math.min(activeTab, newDrafts.length - 1));
        } else {
          handleReset();
        }
      };

      // ======================================================================
      // ITEM MANAGEMENT
      // ======================================================================
      const addItem = () => {
        setFormData({
          ...formData,
          items: [...formData.items, { 
            itemName: '', 
            quantity: '1',
            qtyUnit: '',
            productCode: '',
            subItems: [{ weight: '', laborCost: '' }],
            manualTotal: null
          }]
        });
      };

      const removeItem = (index) => {
        if (formData.items.length > 1) {
          const newItems = formData.items.filter((_, i) => i !== index);
          setFormData({ ...formData, items: newItems });
        }
      };

      const updateItem = (index, field, value) => {
        const newItems = [...formData.items];
        
        if (field === 'quantity') {
          const newQty = parseInt(value) || 1;
          const currentQty = newItems[index].subItems.length;
          
          if (newQty > currentQty) {
            for (let i = currentQty; i < newQty; i++) {
              newItems[index].subItems.push({ weight: '', laborCost: '' });
            }
          } else if (newQty < currentQty) {
            newItems[index].subItems = newItems[index].subItems.slice(0, newQty);
          }
          newItems[index][field] = value;
        } else {
          newItems[index][field] = value;
        }
        
        setFormData({ ...formData, items: newItems });
      };

      const updateSubItem = (itemIndex, subIndex, field, value) => {
        const newItems = [...formData.items];
        newItems[itemIndex].subItems[subIndex][field] = value;
        setFormData({ ...formData, items: newItems });
      };

      // ======================================================================
      // CALCULATIONS
      // ======================================================================
      const calculateSubItemTotal = (subItem) => {
        const { weight, laborCost } = subItem;
        const { goldMix, goldPrice } = formData;

        if (!weight || !goldPrice || !laborCost) return 0;

        const w = parseFloat(weight);
        const gm = parseFloat(goldMix);
        const gp = parseFloat(goldPrice);
        const lc = parseFloat(laborCost);

        return (w * gm * gp / 100000) + lc;
      };

      const roundTotal = (value) => {
        const decimal = value - Math.floor(value);
        return decimal >= 0.7 ? Math.ceil(value) : Math.floor(value);
      };

      const calculateItemTotal = (item) => {
        if (item.manualTotal !== null && item.manualTotal !== undefined) {
          return parseFloat(item.manualTotal) || 0;
        }
        return item.subItems.reduce((sum, subItem) => sum + calculateSubItemTotal(subItem), 0);
      };

      const getCalculatedTotal = (item) => {
        return item.subItems.reduce((sum, subItem) => sum + calculateSubItemTotal(subItem), 0);
      };

      const calculateGrandTotal = () => {
        const rawTotal = formData.items.reduce((sum, item) => sum + calculateItemTotal(item), 0);
        return roundTotal(rawTotal);
      };

      const calculateTotals = () => {
        const totalQty = formData.items.reduce((sum, item) => sum + parseInt(item.quantity || 0), 0);
        const totalWeight = formData.items.reduce((sum, item) => {
          return sum + item.subItems.reduce((s, sub) => s + (parseFloat(sub.weight) || 0), 0);
        }, 0);
        const totalLabor = formData.items.reduce((sum, item) => {
          return sum + item.subItems.reduce((s, sub) => s + (parseFloat(sub.laborCost) || 0), 0);
        }, 0);
        return { totalQty, totalWeight, totalLabor };
      };

      const formatDate = (dateString) => {
        const [year, month, day] = dateString.split('-');
        return `${day}/${month}/${year}`;
      };

      const handleReset = () => {
        setFormData({
          date: new Date().toISOString().split('T')[0],
          clientName: '',
          goldMix: '',
          goldPrice: globalGoldPrice || '', 
          items: [{ 
            itemName: '', 
            quantity: '1',
            qtyUnit: '',
            productCode: '',
            subItems: [{ weight: '', laborCost: '' }],
            manualTotal: null
          }]
        });
      };

      // ======================================================================
      // FILE OPERATIONS
      // ======================================================================
      const handleQRUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const base64 = event.target.result;
            setQrCodeImage(base64);
            localStorage.setItem('jewelryQRCode', base64);
          };
          reader.readAsDataURL(file);
        }
      };

      const handleSelectSavePath = async () => {
        try {
          if (typeof require !== 'undefined') {
            try {
              const { ipcRenderer } = require('electron');
              const result = await ipcRenderer.invoke('select-save-path');
              if (result && result.success) {
                setSavePath(result.path);
                localStorage.setItem('jewelrySavePath', result.path);
                alert(`á‘á¸áá¶áŸ†á„ášá€áŸ’áŸá¶á‘á»á€ááŸ’ášá¼áœá”á¶á“á€áŸ†áááŸ‹!\nPath set: ${result.path}`);
              }
            } catch (electronError) {
              console.error('Electron IPC error:', electronError);
              const folderPath = await showInput('Enter save folder path:', 'C:\\Invoices');
              if (folderPath) {
                setSavePath(folderPath);
                localStorage.setItem('jewelrySavePath', folderPath);
                alert(`á‘á¸áá¶áŸ†á„ášá€áŸ’áŸá¶á‘á»á€ááŸ’ášá¼áœá”á¶á“á€áŸ†áááŸ‹!\nPath set: ${folderPath}`);
              }
            }
          } else {
            const folderPath = await showInput('Enter save folder path:', 'C:\\Invoices');
            if (folderPath) {
              setSavePath(folderPath);
              localStorage.setItem('jewelrySavePath', folderPath);
              alert(`á‘á¸áá¶áŸ†á„ášá€áŸ’áŸá¶á‘á»á€ááŸ’ášá¼áœá”á¶á“á€áŸ†áááŸ‹!\nPath set: ${folderPath}`);
            }
          }
        } catch (error) {
          console.error('Error selecting path:', error);
          alert('Error: ' + error.message);
        }
      };

      const handlePrint = () => {
        setShowPrintView(true);
      };

      const handleSaveReceipt = async () => {
        if (!formData.clientName || !formData.clientName.trim()) {
          alert('áŸá¼á˜á”á‰áŸ’á…á¼á›áˆáŸ’á˜áŸ„áŸ‡á¢áá·áá·á‡á“!\nPlease enter a client name!');
          return;
        }
        
        if (!savePath) {
          alert('áŸá¼á˜á‡áŸ’ášá¾áŸášá¾áŸá‘á¸áá¶áŸ†á„ášá€áŸ’áŸá¶á‘á»á€á‡á¶á˜á»á“áŸá·á“!\nPlease select save path first (Go to Settings)');
          return;
        }
        
        try {
          if (typeof require !== 'undefined') {
            const { ipcRenderer } = require('electron');
            
            const htmlContent = await generateInvoiceHTML(
              formData,
              goldMixOptions,
              qrCodeImage,
              calculateItemTotal,
              formatDate,
              roundTotal
            );

            const goodsList = formData.items.map(item => item.itemName).filter(name => name).join('_');
            const now = new Date();
            const timeStamp = `${now.getHours().toString().padStart(2, '0')}h${now.getMinutes().toString().padStart(2, '0')}`;
            const fileName = `${formatDate(formData.date).replace(/\//g, '-')}_${formData.clientName}_${goodsList}_${timeStamp}`;
            
            const result = await ipcRenderer.invoke('save-pdf', {
              clientName: formData.clientName,
              fileName: fileName,
              basePath: savePath,
              htmlContent: htmlContent
            });
                      
            if (result && result.success) {
              const orderSummary = formData.items
                .map(item => `${item.itemName}${item.productCode ? ` N${item.productCode}` : ''}`)
                .filter(Boolean)
                .join(', ');
              
              const paymentRecord = {
                id: Date.now(),
                clientName: formData.clientName,
                orders: orderSummary,
                savedTime: new Date().toLocaleString(),
                total: calculateGrandTotal(),
                status: 'pending',
                filePath: result.path
              };
              
              addPaymentRecord(paymentRecord);
              
              if (confirm(`ášá€áŸ’áŸá¶á‘á»á€á‡áŸ„á‚á‡áŸá™! / Saved Successfully!\n\nPath: ${result.path}\n\náá¾á¢áŸ’á“á€á…á„áŸ‹á”á¾á€á¯á€áŸá¶ášáŠá¾á˜áŸ’á”á¸á”áŸ„áŸ‡á–á»á˜áŸ’á–á‘áŸ?\nDo you want to open the file to print?`)) {
                await ipcRenderer.invoke('open-file', result.path);
              }
            } else {
              alert(`á”ášá¶á‡áŸá™á€áŸ’á“á»á„á€á¶ášášá€áŸ’áŸá¶á‘á»á€! / Save Failed!\n\n${result?.error || 'Unknown error'}`);
            }
          } else {
            alert('Save feature only works in desktop app');
          }
        } catch (error) {
          console.error('Save error:', error);
          alert(`Error: ${error.message}`);
        }
      };

      // ======================================================================
      // SETTINGS OPTIONS MANAGEMENT
      // ======================================================================
      const addQtyUnit = (newUnit) => {
        const updated = [...qtyUnitOptions, newUnit];
        setQtyUnitOptions(updated);
        localStorage.setItem('jewelryQtyUnits', JSON.stringify(updated));
      };

      const removeQtyUnit = (unitToRemove) => {
        const updated = qtyUnitOptions.filter(u => u !== unitToRemove);
        setQtyUnitOptions(updated);
        localStorage.setItem('jewelryQtyUnits', JSON.stringify(updated));
      };

      const addGoldMix = (newMix) => {
        const isDuplicate = goldMixOptions.some(mix => mix.value === newMix.value);
        if (isDuplicate) {
          alert(`âŒ Error: Value "${newMix.value}" already exists!\nPlease use a unique value.`);
          return;
        }
        const updated = [...goldMixOptions, newMix];
        setGoldMixOptions(updated);
        localStorage.setItem('jewelryGoldMix', JSON.stringify(updated));
      };

      const removeGoldMix = (valueToRemove) => {
        const updated = goldMixOptions.filter(m => m.value !== valueToRemove);
        setGoldMixOptions(updated);
        localStorage.setItem('jewelryGoldMix', JSON.stringify(updated));
      };

      // ======================================================================
      // PAYMENT HISTORY
      // ======================================================================
      const addPaymentRecord = (record) => {
        const updated = [record, ...paymentHistory];
        setPaymentHistory(updated);
        localStorage.setItem('jewelryPaymentHistory', JSON.stringify(updated));
      };

      const updatePaymentStatus = (id, status) => {
        const updated = paymentHistory.map(record => 
          record.id === id ? { ...record, status } : record
        );
        setPaymentHistory(updated);
        localStorage.setItem('jewelryPaymentHistory', JSON.stringify(updated));
      };

      const deletePaymentRecord = (id) => {
        const updated = paymentHistory.filter(record => record.id !== id);
        setPaymentHistory(updated);
        localStorage.setItem('jewelryPaymentHistory', JSON.stringify(updated));
      };

      const restartPrintSpooler = async () => {
        try {
          if (typeof require !== 'undefined') {
            const { ipcRenderer } = require('electron');
            const result = await ipcRenderer.invoke('restart-print-spooler');
            
            if (result.success) {
              alert('âœ“ Print Spooler restarted successfully!\nYou can now try printing again.');
            } else {
              alert('âœ— Failed to restart Print Spooler.\nPlease try manually via services.msc');
            }
          } else {
            alert('This feature only works in the desktop app');
          }
        } catch (error) {
          alert('Error: ' + error.message);
        }
      };

      const totals = calculateTotals();

      // ======================================================================
      // PAYMENT HISTORY PAGE
      // ======================================================================
      if (currentPage === 'payment') {
        return (
          <div className="min-h-screen bg-gray-50">
            <Header 
              formData={formData}
              setFormData={setFormData}
              saveDraft={saveDraft}
              handleSaveReceipt={handleSaveReceipt}
              globalGoldPrice={globalGoldPrice}
              setGlobalGoldPrice={setGlobalGoldPrice}
            />

            <div className="flex pt-20">
              <Sidebar 
                currentPage={currentPage}
                setCurrentPage={setCurrentPage}
                drafts={drafts}
                activeTab={activeTab}
                loadDraft={loadDraft}
                deleteDraft={deleteDraft}
                addNewDraft={addNewDraft}
                restartPrintSpooler={restartPrintSpooler}
              />

              <div className="flex-1 ml-64 p-8">
                <h2 className="text-2xl font-bold mb-6">á”áŸ’ášáœááŸ’áá·á€á¶ášá‘á¼á‘á¶ááŸ‹ / Payment History</h2>

              <div className="mb-8">
                <h3 className="text-xl font-semibold mb-4 text-yellow-700">â³ Pending Orders</h3>
                <div className="bg-white rounded-lg shadow">
                  {paymentHistory.filter(r => r.status === 'pending').length === 0 ? (
                    <div className="p-8 text-center text-gray-500">No pending orders</div>
                  ) : (
                    <div className="divide-y">
                      {paymentHistory.filter(r => r.status === 'pending').map((record) => (
                        <div key={record.id} className="p-4 hover:bg-gray-50 flex items-center gap-4">
                          <div className="flex-1">
                            <div className="font-semibold text-lg">{record.clientName}</div>
                            <div className="text-sm text-gray-600">{record.orders}</div>
                            <div className="text-xs text-gray-500 mt-1">{record.savedTime}</div>
                          </div>
                          <div className="text-right">
                            <div className="text-xl font-bold text-blue-600">${record.total.toLocaleString()}</div>
                          </div>
                          <div className="flex gap-2 items-center">
                            <button
                              onClick={() => updatePaymentStatus(record.id, 'paid')}
                              className="p-2 bg-green-600 text-white rounded hover:bg-green-700 text-xl"
                              title="Mark as Paid"
                            >
                              âœ“
                            </button>
                            <div className="px-4 py-2 rounded border-2 bg-yellow-100 text-yellow-800 border-yellow-300 font-semibold text-sm min-w-28 text-center">
                              PENDING
                            </div>
                            <button
                              onClick={() => updatePaymentStatus(record.id, 'cancelled')}
                              className="p-2 bg-red-600 text-white rounded hover:bg-red-700 text-xl"
                              title="Cancel"
                            >
                              âœ—
                            </button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              <div>
                <h3 className="text-xl font-semibold mb-4 text-gray-700">ğŸ“‹ History</h3>
                <div className="bg-white rounded-lg shadow">
                  {paymentHistory.filter(r => r.status !== 'pending').length === 0 ? (
                    <div className="p-8 text-center text-gray-500">No history yet</div>
                  ) : (
                    <div className="divide-y">
                      {paymentHistory.filter(r => r.status !== 'pending').map((record) => {
                        const statusColors = {
                          paid: { bg: 'bg-green-100', text: 'text-green-800', border: 'border-green-300' },
                          cancelled: { bg: 'bg-red-100', text: 'text-red-800', border: 'border-red-300' }
                        };
                        const colors = statusColors[record.status];
                        
                        return (
                          <div key={record.id} className="p-4 hover:bg-gray-50 flex items-center gap-4">
                            <div className="flex-1">
                              <div className="font-semibold text-lg">{record.clientName}</div>
                              <div className="text-sm text-gray-600">{record.orders}</div>
                              <div className="text-xs text-gray-500 mt-1">{record.savedTime}</div>
                            </div>
                            <div className="text-right">
                              <div className="text-xl font-bold text-blue-600">${record.total.toLocaleString()}</div>
                            </div>
                            <div className={`px-4 py-2 rounded border-2 ${colors.bg} ${colors.text} ${colors.border} font-semibold text-sm min-w-28 text-center`}>
                              {record.status.toUpperCase()}
                            </div>
                            <button
                              onClick={() => deletePaymentRecord(record.id)}
                              className="p-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                              title="Delete"
                            >
                              <X size={16} />
                            </button>
                          </div>
                        );
                      })}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>
          </div>
        );
      }

      // ======================================================================
      // SETTINGS PAGE
      // ======================================================================
      if (currentPage === 'settings') {
        return (
          <div className="min-h-screen bg-gray-50">
            <Header 
              formData={formData}
              setFormData={setFormData}
              saveDraft={saveDraft}
              handleSaveReceipt={handleSaveReceipt}
              globalGoldPrice={globalGoldPrice}
              setGlobalGoldPrice={setGlobalGoldPrice}
            />

            <div className="flex pt-20">
              <Sidebar 
                currentPage={currentPage}
                setCurrentPage={setCurrentPage}
                drafts={drafts}
                activeTab={activeTab}
                loadDraft={loadDraft}
                deleteDraft={deleteDraft}
                addNewDraft={addNewDraft}
                restartPrintSpooler={restartPrintSpooler}
              />

              {/* Input Modal */}
              <InputModal
                isOpen={showInputModal}
                title={inputModalData.title}
                defaultValue={inputModalData.defaultValue}
                onSubmit={inputModalData.onSubmit}
                onCancel={closeInputModal}
              />

              <div className="flex-1 ml-64 p-8">
                <h2 className="text-2xl font-bold mb-6">á€á¶ášá€áŸ†áááŸ‹ / Settings</h2>

              {/* Save Path */}
              <div className="bg-white rounded-lg shadow p-6 mb-6">
                <h3 className="text-lg font-semibold mb-4">ášá€áŸ’áŸá¶á‘á»á€á‘á¸ / Save Path</h3>
                <div className="flex gap-2 items-center">
                  <button
                    onClick={handleSelectSavePath}
                    className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                  >
                    Browse...
                  </button>
                  <span className="text-sm text-gray-600">{savePath || 'Not set'}</span>
                </div>
              </div>

              {/* Client Management */}
              <div className="bg-white rounded-lg shadow p-6 mb-6">
                <h3 className="text-lg font-semibold mb-4">áˆáŸ’á˜áŸ„áŸ‡á¢áá·áá·á‡á“ / Client Names</h3>
                <div className="flex gap-2 mb-3">
                  <input
                    type="text"
                    value={newClientName}
                    onChange={(e) => setNewClientName(e.target.value)}
                    onKeyPress={(e) => {
                      if (e.key === 'Enter' && newClientName.trim()) {
                        saveClient();
                      }
                    }}
                    placeholder="Add new client name..."
                    className="flex-1 px-3 py-2 border rounded"
                  />
                  <button
                    onClick={saveClient}
                    className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                  >
                    Add
                  </button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {clients.length === 0 ? (
                    <p className="text-sm text-gray-500">No clients added yet</p>
                  ) : (
                    clients.map((client, idx) => (
                      <span
                        key={idx}
                        className="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 rounded"
                      >
                        {client}
                        <button
                          onClick={() => removeClient(client)}
                          className="text-red-600 hover:text-red-800"
                        >
                          <X size={14} />
                        </button>
                      </span>
                    ))
                  )}
                </div>
              </div>

              {/* QR Code */}
              <div className="bg-white rounded-lg shadow p-6 mb-6">
                <h3 className="text-lg font-semibold mb-4">QR Code</h3>
                <input
                  type="file"
                  accept="image/*"
                  onChange={handleQRUpload}
                  className="mb-2"
                />
                {qrCodeImage && (
                  <img src={qrCodeImage} alt="QR Preview" className="w-32 h-auto mt-2" />
                )}
              </div>

              {/* GROUPED Type of Goods */}
              <div className="bg-white rounded-lg shadow p-6 mb-6">
                <div className="flex justify-between items-center mb-4">
                  <h3 className="text-lg font-semibold">á”áŸ’ášá—áŸá‘á‚áŸ’ášá¿á„ / Type of Goods (Grouped)</h3>
                  <button
                    onClick={async () => {
                      const groupName = await showInput('Enter group name:');
                      if (groupName) {
                        addGroup(groupName);
                      }
                    }}
                    className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-1"
                  >
                    <Plus size={14} />
                    Add Group
                  </button>
                </div>

                {itemTypeGroups.length === 0 ? (
                  <p className="text-sm text-gray-500">No groups yet. Click "Add Group" to create one.</p>
                ) : (
                  <div className="space-y-4">
                    {itemTypeGroups.map((group, groupIdx) => (
                      <div key={groupIdx} className="border rounded-lg p-4 bg-gray-50">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="font-semibold text-md text-blue-700">{group.name}</h4>
                          <div className="flex gap-2">
                            <button
                              onClick={async () => {
                                const newName = await showInput('Rename group:', group.name);
                                if (newName) {
                                  renameGroup(groupIdx, newName);
                                }
                              }}
                              className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
                            >
                              Rename
                            </button>
                            <button
                              onClick={() => {
                                if (confirm(`Delete group "${group.name}"?`)) {
                                  removeGroup(groupIdx);
                                }
                              }}
                              className="text-xs px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200"
                            >
                              Delete Group
                            </button>
                          </div>
                        </div>

                        <div className="flex gap-2 mb-3">
                          <input
                            type="text"
                            id={`newItem-${groupIdx}`}
                            placeholder="Add new item..."
                            className="flex-1 px-3 py-2 border rounded text-sm"
                            onKeyPress={(e) => {
                              if (e.key === 'Enter' && e.target.value.trim()) {
                                addItemToGroup(groupIdx, e.target.value.trim());
                                e.target.value = '';
                              }
                            }}
                          />
                          <button
                            onClick={() => {
                              const input = document.getElementById(`newItem-${groupIdx}`);
                              if (input.value.trim()) {
                                addItemToGroup(groupIdx, input.value.trim());
                                input.value = '';
                              }
                            }}
                            className="px-3 py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm"
                          >
                            Add
                          </button>
                        </div>

                        <div className="flex flex-wrap gap-2">
                          {group.items.length === 0 ? (
                            <p className="text-xs text-gray-500">No items in this group yet</p>
                          ) : (
                            group.items.map((item, itemIdx) => (
                              <span
                                key={itemIdx}
                                className="inline-flex items-center gap-1 px-2 py-1 bg-white border rounded text-sm"
                              >
                                {item}
                                <button
                                  onClick={() => removeItemFromGroup(groupIdx, itemIdx)}
                                  className="text-red-600 hover:text-red-800"
                                >
                                  <X size={12} />
                                </button>
                              </span>
                            ))
                          )}
                        </div>
                      </div>
                    ))}
                  </div>
                )}
              </div>

              {/* Quantity Units */}
              <div className="bg-white rounded-lg shadow p-6 mb-6">
                <h3 className="text-lg font-semibold mb-4">á¯á€áá¶á…áŸ†á“á½á“ / Quantity Units</h3>
                <div className="flex gap-2 mb-3">
                  <input
                    type="text"
                    id="newQtyUnit"
                    placeholder="Add new unit..."
                    className="flex-1 px-3 py-2 border rounded"
                    onKeyPress={(e) => {
                      if (e.key === 'Enter' && e.target.value.trim()) {
                        addQtyUnit(e.target.value.trim());
                        e.target.value = '';
                      }
                    }}
                  />
                  <button
                    onClick={() => {
                      const input = document.getElementById('newQtyUnit');
                      if (input.value.trim()) {
                        addQtyUnit(input.value.trim());
                        input.value = '';
                      }
                    }}
                    className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                  >
                    Add
                  </button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {qtyUnitOptions.filter(u => u).map((unit, idx) => (
                    <span
                      key={idx}
                      className="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 rounded"
                    >
                      {unit}
                      <button
                        onClick={() => removeQtyUnit(unit)}
                        className="text-red-600 hover:text-red-800"
                      >
                        <X size={14} />
                      </button>
                    </span>
                  ))}
                </div>
              </div>

              {/* Gold Mix */}
              <div className="bg-white rounded-lg shadow p-6">
                <h3 className="text-lg font-semibold mb-4">á•áŸ’á›á¶á‘á¸á“á‘á¹á€ / Gold Mix Options</h3>
                <div className="flex gap-2 mb-3">
                  <input
                    type="text"
                    id="newGoldLabel"
                    placeholder="Label (e.g., 80%)"
                    className="flex-1 px-3 py-2 border rounded"
                  />
                  <input
                    type="text"
                    id="newGoldValue"
                    placeholder="Value (e.g., 80)"
                    className="flex-1 px-3 py-2 border rounded"
                  />
                  <button
                    onClick={() => {
                      const labelInput = document.getElementById('newGoldLabel');
                      const valueInput = document.getElementById('newGoldValue');
                      if (labelInput.value.trim() && valueInput.value.trim()) {
                        const newMix = { label: labelInput.value.trim(), value: valueInput.value.trim() };
                        const isDuplicate = goldMixOptions.some(mix => mix.value === newMix.value);
                        addGoldMix(newMix);
                        if (!isDuplicate) {
                          labelInput.value = '';
                          valueInput.value = '';
                        }
                      } else {
                        alert('Please fill in both label and value');
                      }
                    }}
                    className="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                  >
                    Add
                  </button>
                </div>
                <div className="flex flex-wrap gap-2">
                  {goldMixOptions.map((mix, idx) => (
                    <span
                      key={idx}
                      className="inline-flex items-center gap-1 px-3 py-1 bg-gray-100 rounded"
                    >
                      {mix.label} <span className="text-xs text-gray-500">({mix.value})</span>
                      <button
                        onClick={() => removeGoldMix(mix.value)}
                        className="text-red-600 hover:text-red-800"
                      >
                        <X size={14} />
                      </button>
                    </span>
                  ))}
                </div>
              </div>
            </div>
          </div>
          </div>
        );
      }

      // ======================================================================
      // PRINT VIEW
      // ======================================================================
      if (showPrintView) {
        return (
          <div className="min-h-screen bg-white p-8">
            <div className="max-w-3xl mx-auto">
              <div className="mb-8 no-print">
                <button
                  onClick={() => setShowPrintView(false)}
                  className="mb-4 px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700"
                >
                  â† ááŸ’ášá¡á”áŸ‹á€áŸ’ášáŸ„á™ / Back
                </button>
                <button
                  onClick={() => window.print()}
                  className="ml-2 mb-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                >
                  á”áŸ„áŸ‡á–á»á˜áŸ’á– / Print
                </button>
              </div>

              <div className="border-2 border-gray-300 p-8">
                <h1 className="text-3xl font-bold text-center mb-2">á¢á¼á¡á¶áŸ†á–áŸ’á™á¶ á…á¶á€áŸ‹á–á»á˜áŸ’á–á‚áŸ’ášá¿á„á¢á›á„áŸ’á€á¶áš</h1>
                <div className="text-lg text-center mb-6 text-gray-700 leading-relaxed">
                  á˜á¶á“á‘á‘á½á›á…á¶á€áŸ‹á–á»á˜áŸ’á–á‚áŸ’ášá¿á„á¢á›á„áŸ’á€á¶ášá‚áŸ’ášá”áŸ‹á”áŸ’ášá—áŸá‘<br/>áŠáŸ„á™á˜áŸ‰á¶áŸáŸ’áŸá¸á“áŸáŸ’áœáŸá™á”áŸ’ášáœááŸ’áá·á™áŸ‰á¶á„á‘áŸ†á“á¾á”á‘á¶á“áŸ‹á…á·ááŸ’á
                </div>
                
                <h2 className="text-3xl font-bold text-center mb-6">áœá·á€áŸá™á”áŸááŸ’áš / INVOICE</h2>
                
                <div className="flex justify-between mb-6">
                  <div className="text-lg">
                    <div>TEL: 012205358</div>
                    <div style={{paddingLeft: '28px'}}>061848616</div>
                  </div>
                  <div className="text-right text-lg leading-relaxed">
                    á•áŸ’á‘áŸ‡á›áŸá10C1E0 á•áŸ’á›á¼áœá›áŸá211<br/>áŸá„áŸ’á€á¶ááŸ‹áœá¶á›áœá„áŸ‹ áááŸ’áŒáŸ§á˜á€ášá¶
                  </div>
                </div>
                
                <div className="mb-6 text-base">
                  <div className="flex justify-between mb-2">
                    <span className="font-semibold">ááŸ’á„áŸƒá‘á¸ / Date:</span>
                    <span>{formatDate(formData.date)}</span>
                  </div>
                  <div className="flex justify-between mb-2">
                    <span className="font-semibold">áˆáŸ’á˜áŸ„áŸ‡á¢áá·áá·á‡á“ / Client Name:</span>
                    <span>{formData.clientName}</span>
                  </div>
                  <div className="flex justify-between mb-2">
                    <span className="font-semibold">á•áŸ’á›á¶á‘á¸á“á‘á¹á€ / Gold Mix:</span>
                    <span>{goldMixOptions.find(o => o.value === formData.goldMix)?.label}</span>
                  </div>
                  <div className="flex justify-between mb-2">
                    <span className="font-semibold">á á¶á„á†áŸá„ / Gold Market Price:</span>
                    <span>${formData.goldPrice}</span>
                  </div>
                </div>

                <table className="w-full mb-6 border-collapse text-base">
                  <thead>
                    <tr className="border-b-2 border-gray-300">
                      <th className="text-left py-3 px-2">á”áŸ’ášá—áŸá‘á‚áŸ’ášá¿á„<br/>Type of Goods</th>
                      <th className="text-center py-3 px-2">á…áŸ†á“á½á“<br/>Qty</th>
                      <th className="text-center py-3 px-2">á‘áŸ†á„á“áŸ‹<br/>Weight (l)</th>
                      <th className="text-right py-3 px-2">áˆáŸ’á“á½á›<br/>Labor</th>
                      <th className="text-right py-3 px-2">áŸášá»á”<br/>Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    {formData.items.map((item, idx) => {
                      let totalW = 0;
                      let totalL = 0;
                      
                      if (item.subItems && item.subItems.length > 0) {
                        item.subItems.forEach(sub => {
                          totalW += parseFloat(sub.weight) || 0;
                          totalL += parseFloat(sub.laborCost) || 0;
                        });
                      }
                      
                      return (
                        <tr key={`item-${idx}`} className="border-b border-gray-200">
                          <td className="py-3 px-2">
                            {item.itemName}
                            {item.productCode && ` N${item.productCode}`}
                          </td>
                          <td className="text-center py-3 px-2">{item.quantity}{item.qtyUnit}</td>
                          <td className="text-center py-3 px-2">{totalW.toFixed(1)}</td>
                          <td className="text-right py-3 px-2">${totalL}</td>
                          <td className="text-right py-3 px-2 font-semibold">${roundTotal(calculateItemTotal(item)).toLocaleString()}</td>
                        </tr>
                      );
                    })}
                    <tr className="border-t-2 border-gray-300 font-semibold">
                      <td className="py-3 px-2">áŸášá»á” / TOTAL</td>
                      <td className="text-center py-3 px-2">{totals.totalQty}</td>
                      <td className="text-center py-3 px-2">{totals.totalWeight.toFixed(1)}</td>
                      <td className="text-right py-3 px-2">${totals.totalLabor}</td>
                      <td className="text-right py-3 px-2"></td>
                    </tr>
                  </tbody>
                </table>

                <div className="flex justify-between items-start mb-6">
                  <div className="text-lg text-gray-600 max-w-md leading-relaxed">
                    á¢áŸ’á“á€á‘á·á‰á”á¶á“á˜á¾á› ááŸ’á›á¹á„ á“á¹á„á™á›áŸ‹á–áŸ’ášá˜<br/>áá¶á˜á‘áŸ†á„á“áŸ‹áá¶á„á›á¾ááŸ’ášá¹á˜ááŸ’ášá¼áœáŸ”
                  </div>
                  <div className="text-right">
                    <div className="text-2xl font-bold mb-1">
                      <span className="mr-4">áŸášá»á”ášá½á˜ / GRAND TOTAL:</span>
                      <span className="text-3xl">${calculateGrandTotal().toLocaleString()}</span>
                    </div>
                  </div>
                </div>

                {qrCodeImage && (
                  <div className="flex justify-center mt-4">
                    <img src={qrCodeImage} alt="QR Code" className="w-48 h-auto" />
                  </div>
                )}
              </div>
            </div>
            
            <style>{`
              @media print {
                @page {
                  size: A4;
                  margin: 10mm;
                }
                .no-print {
                  display: none !important;
                }
                body {
                  print-color-adjust: exact;
                  -webkit-print-color-adjust: exact;
                }
              }
            `}</style>
          </div>
        );
      }

      // ======================================================================
      // INVOICE PAGE (MAIN)
      // ======================================================================
      return (
        <div className="min-h-screen bg-gray-50">
          <Header 
            formData={formData}
            setFormData={setFormData}
            saveDraft={saveDraft}
            handleSaveReceipt={handleSaveReceipt}
            globalGoldPrice={globalGoldPrice}
            setGlobalGoldPrice={setGlobalGoldPrice}
          />

          <div className="flex pt-20">
            <Sidebar 
              currentPage={currentPage}
              setCurrentPage={setCurrentPage}
              drafts={drafts}
              activeTab={activeTab}
              loadDraft={loadDraft}
              deleteDraft={deleteDraft}
              addNewDraft={addNewDraft}
              restartPrintSpooler={restartPrintSpooler}
            />

            {showTypeSelector && (
              <GroupedTypeSelector
                groups={itemTypeGroups}
                onSelect={(selectedItem) => {
                  updateItem(currentItemIndex, 'itemName', selectedItem);
                }}
                onClose={() => {
                  setShowTypeSelector(false);
                  setCurrentItemIndex(null);
                }}
              />
            )}

            <div className="flex-1 ml-64 p-8">
              <div className="max-w-4xl mx-auto">
                <div className="bg-white rounded-lg shadow-sm p-6">

              {drafts.length === 0 && (
                <div className="mb-4">
                  <button
                    onClick={addNewDraft}
                    className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-1"
                  >
                    <Plus size={14} />
                    á”á“áŸ’ááŸ‚á˜ááŸ’á˜á¸ / New Draft
                  </button>
                </div>
              )}

              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    áˆáŸ’á˜áŸ„áŸ‡á¢áá·áá·á‡á“ / Client Name
                  </label>
                  <select
                    value={formData.clientName}
                    onChange={(e) => setFormData({ ...formData, clientName: e.target.value })}
                    className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                    required
                  >
                    <option value="">á‡áŸ’ášá¾áŸášá¾áŸá¢áá·áá·á‡á“... / Select client...</option>
                    {clients.map((client, idx) => (
                      <option key={idx} value={client}>{client}</option>
                    ))}
                  </select>
                  <p className="text-xs text-gray-500 mt-1">Add new clients in Settings</p>
                </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  á•áŸ’á›á¶á‘á¸á“á‘á¹á€ / Gold Mix
                </label>
                <select
                  value={formData.goldMix}
                  onChange={(e) => setFormData({ ...formData, goldMix: e.target.value })}
                  className="w-full px-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="">-- á‡áŸ’ášá¾áŸášá¾áŸ / Select --</option>
                  {goldMixOptions.map((option) => (
                    <option key={option.value} value={option.value}>
                      {option.label}
                    </option>
                  ))}
                </select>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  á á¶á„á†áŸá„ / Gold Market Price
                  {globalGoldPrice && (
                    <span className="text-xs text-gray-500 ml-2">
                      (Default: ${globalGoldPrice})
                    </span>
                  )}
                </label>
                <div className="relative">
                  <span className="absolute left-3 top-2.5 text-gray-500">$</span>
                  <input
                    type="number"
                    step="1"
                    value={formData.goldPrice}
                    onChange={(e) => setFormData({ ...formData, goldPrice: e.target.value })}
                    placeholder={globalGoldPrice || 'Enter price'}
                    className="w-full pl-7 pr-3 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                </div>
              </div>
            </div>

            <div className="border-t pt-4 mt-4">
              <div className="flex justify-between items-center mb-3">
                <h2 className="text-lg font-semibold text-gray-800">á‚áŸ’ášá¿á„ / Items</h2>
                <button
                  onClick={addItem}
                  className="px-3 py-1 bg-green-600 text-white rounded hover:bg-green-700 flex items-center gap-1"
                >
                  <Plus size={16} />
                  á”á“áŸ’ááŸ‚á˜ / Add Item
                </button>
              </div>

              {formData.items.map((item, idx) => (
                <div key={idx} className="mb-4 p-4 bg-gray-50 rounded border border-gray-200">
                  <div className="flex gap-2 items-start mb-3">
                    <div className="flex-1">
                      <label className="block text-xs font-medium text-gray-600 mb-1">á”áŸ’ášá—áŸá‘á‚áŸ’ášá¿á„ / Type of Goods</label>
                      <button
                        onClick={() => {
                          setCurrentItemIndex(idx);
                          setShowTypeSelector(true);
                        }}
                        className="w-full px-3 py-2 border border-gray-300 rounded text-left hover:bg-gray-100 focus:ring-2 focus:ring-blue-500"
                      >
                        {item.itemName || '-- á‡áŸ’ášá¾áŸášá¾áŸ / Select --'}
                      </button>
                    </div>
                    <div className="w-24">
                      <label className="block text-xs font-medium text-gray-600 mb-1">á›áŸáá€á¼áŠ / Code</label>
                      <input
                        type="text"
                        placeholder="â„–"
                        value={item.productCode}
                        onChange={(e) => updateItem(idx, 'productCode', e.target.value)}
                        className="w-full px-2 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                      />
                    </div>
                    <div className="w-32">
                          <label className="block text-xs font-medium text-gray-600 mb-1">á…áŸ†á“á½á“ / Qty</label>
                          <div className="flex gap-1">
                            <input
                              type="number"
                              min="1"
                              step="1"
                              value={item.quantity}
                              onChange={(e) => updateItem(idx, 'quantity', e.target.value)}
                              className="w-16 px-2 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                            />
                            <select
                              value={item.qtyUnit}
                              onChange={(e) => updateItem(idx, 'qtyUnit', e.target.value)}
                              className="w-14 px-1 py-2 border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 text-xs"
                            >
                              {qtyUnitOptions.map((unit, i) => (
                                <option key={i} value={unit}>{unit || '-'}</option>
                              ))}
                            </select>
                          </div>
                        </div>
                    <div className="w-40 pt-6">
                          <div className="flex gap-1 items-center">
                            <input
                              type="number"
                              step="1"
                              value={item.manualTotal !== null ? item.manualTotal : ''}
                              onChange={(e) => updateItem(idx, 'manualTotal', e.target.value === '' ? null : e.target.value)}
                              className="w-24 text-sm font-semibold text-gray-700 px-2 py-2 bg-white rounded border border-gray-300 focus:ring-2 focus:ring-blue-500"
                              placeholder={roundTotal(getCalculatedTotal(item)).toString()}
                            />
                            {item.manualTotal !== null && (
                              <button
                                onClick={() => updateItem(idx, 'manualTotal', null)}
                                className="p-1 text-blue-600 hover:bg-blue-50 rounded"
                                title="Reset to calculated"
                              >
                                â†»
                              </button>
                            )}
                          </div>
                        </div>
                    {formData.items.length > 1 && (
                      <button
                        onClick={() => removeItem(idx)}
                        className="mt-6 p-2 text-red-600 hover:bg-red-50 rounded"
                      >
                        <X size={20} />
                      </button>
                    )}
                  </div>

                  <div className="ml-4 space-y-2">
                    {item.subItems.map((subItem, subIdx) => (
                      <div key={subIdx} className="flex gap-2 items-center bg-white p-2 rounded border border-gray-200">
                        <span className="text-xs text-gray-500 w-12">#{subIdx + 1}</span>
                        <div className="flex-1">
                          <input
                            type="number"
                            step="1"
                            placeholder="á‘áŸ†á„á“áŸ‹ / Weight"
                            value={subItem.weight}
                            onChange={(e) => updateSubItem(idx, subIdx, 'weight', e.target.value)}
                            className="w-full px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                          />
                        </div>
                        <div className="flex-1">
                          <div className="relative">
                            <span className="absolute left-2 top-1 text-gray-500 text-xs">$</span>
                            <input
                              type="number"
                              step="1"
                              placeholder="áˆáŸ’á“á½á› / Labor"
                              value={subItem.laborCost}
                              onChange={(e) => updateSubItem(idx, subIdx, 'laborCost', e.target.value)}
                              className="w-full pl-5 pr-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500"
                            />
                          </div>
                        </div>
                        <div className="w-24 text-right text-sm font-semibold text-gray-700">
                          ${calculateSubItemTotal(subItem).toFixed(2)}
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              ))}

              <div className="mt-2 p-3 bg-blue-50 rounded border border-blue-200">
                <div className="flex gap-4 items-center">
                  <div className="flex-1">
                    <div className="text-xs text-gray-500 mb-1">áŸášá»á” / TOTAL</div>
                    <div className="font-semibold text-gray-700">áŸášá»á” / TOTAL</div>
                  </div>
                  <div className="text-center">
                    <div className="text-xs text-gray-500 mb-1">á…áŸ†á“á½á“ / Qty</div>
                    <div className="font-semibold text-gray-700">{totals.totalQty}</div>
                  </div>
                  <div className="text-center">
                    <div className="text-xs text-gray-500 mb-1">á‘áŸ†á„á“áŸ‹ / Weight</div>
                    <div className="font-semibold text-gray-700">{totals.totalWeight.toFixed(1)}</div>
                  </div>
                  <div className="text-center">
                    <div className="text-xs text-gray-500 mb-1">áˆáŸ’á“á½á› / Labor</div>
                    <div className="font-semibold text-gray-700">${totals.totalLabor}</div>
                  </div>
                </div>
              </div>
            </div>

            <div className="border-t pt-4 mt-6">
              <div className="flex justify-between items-center">
                <span className="text-lg font-semibold text-gray-700">áŸášá»á”ášá½á˜ / Grand Total:</span>
                <span className="text-2xl font-bold text-blue-600">${calculateGrandTotal().toLocaleString()}</span>
              </div>
            </div>

            <div className="flex justify-between items-center mt-4">
              <button
                onClick={handleReset}
                className="px-6 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300"
              >
                á€áŸ†áááŸ‹á¡á¾á„áœá·á‰ / Reset
              </button>
              <button
                onClick={handlePrint}
                className="flex items-center justify-center gap-2 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                <Printer size={18} />
                á”áŸ„áŸ‡á–á»á˜áŸ’á– / Print
              </button>
            </div>
          </div>
              </div>
            </div>
          </div>
        </div>
        </div>
      );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ReceiptCalculator />);
  </script>
</body>
</html>
